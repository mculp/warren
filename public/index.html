<!DOCTYPE html>
<html>
<head>
    <title>Warren</title>
    <script src="//unpkg.com/3d-force-graph"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Helvetica Neue', sans-serif; background: #000; }
        
        /* HUD: Title and Reading Panel */
        #reading-panel {
            position: absolute; top: 20px; left: 20px; width: 350px;
            max-height: 90vh; overflow-y: auto;
            background: rgba(20, 20, 20, 0.9); color: #e0e0e0;
            padding: 25px; border-radius: 12px;
            border: 1px solid #333; backdrop-filter: blur(10px);
            transition: transform 0.4s ease; z-index: 100;
        }
        
        #reading-panel.minimized { transform: translateX(-120%); }

        h1 { margin-top: 0; font-size: 28px; font-weight: 300; letter-spacing: -1px; color: #fff; }
        p { line-height: 1.6; font-size: 14px; color: #bbb; }
        
        /* HUD: Controls */
        #controls { position: absolute; bottom: 30px; left: 30px; z-index: 100; display: flex; gap: 10px; }
        
        button {
            background: rgba(255, 255, 255, 0.1); border: 1px solid #555;
            color: white; padding: 10px 20px; border-radius: 20px;
            cursor: pointer; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;
            transition: background 0.2s;
        }
        button:hover { background: rgba(255, 255, 255, 0.3); }

        /* Loading Indicator */
        #loader { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #4db8ff; display: none; pointer-events: none; z-index: 50;
        }
    </style>
</head>
<body>

    <div id="reading-panel">
        <h1 id="article-title">Warren</h1>
        <p id="article-summary">Search or click a node to begin...</p>
    </div>

    <div id="controls">
        <button onclick="togglePanel()">Toggle Read View</button>
        <button onclick="Graph.zoomToFit(1000)">Reset Camera</button>
    </div>
    
    <div id="loader">Loading Data...</div>
    <div id="3d-graph"></div>

    <script>
        let isPanelVisible = true;
        const panel = document.getElementById('reading-panel');
        const loader = document.getElementById('loader');

        // Initialize 3D Graph
        const Graph = ForceGraph3D()(document.getElementById('3d-graph'))
            .backgroundColor('#050505')
            .nodeLabel('name')
            .nodeColor(node => node.type === 'center' ? '#ff3366' : '#4db8ff') // Red for Center, Blue for links
            .nodeVal('popularitySize') 
            .linkOpacity(0.3)
            .linkWidth(1)
            .onNodeClick(node => {
                focusOnNode(node);
            });

        function focusOnNode(node) {
            // Fly camera to node
            const distance = 100;
            const distRatio = 1 + distance/Math.hypot(node.x, node.y, node.z);
            
            Graph.cameraPosition(
                { x: node.x * distRatio, y: node.y * distRatio, z: node.z * distRatio },
                node, 
                2000 
            );

            // Fetch new data
            fetchArticle(node.name);
        }

        function fetchArticle(title) {
            loader.style.display = 'block';
            
            // Call our Ruby Backend
            fetch(`/api/data?article=${encodeURIComponent(title)}`)
                .then(res => res.json())
                .then(data => {
                    loader.style.display = 'none';
                    if(data.error) return alert(data.error);

                    // Update Text
                    document.getElementById('article-title').innerText = data.centerNode.name;
                    document.getElementById('article-summary').innerText = data.centerNode.summary;
                    
                    // Update Graph
                    // For the \"Infinite Canvas\" effect, we merge new nodes with old ones
                    const { nodes, links } = Graph.graphData();
                    
                    // Simple logic: Replace graph for now to keep performance high for MVP
                    // (We can add complex merging logic in Phase 2)
                    const newData = {
                        nodes: [data.centerNode, ...data.orbitNodes],
                        links: data.orbitNodes.map(n => ({ source: data.centerNode.id, target: n.id }))
                    };

                    Graph.graphData(newData);
                });
        }

        function togglePanel() {
            isPanelVisible = !isPanelVisible;
            if (isPanelVisible) panel.classList.remove('minimized');
            else panel.classList.add('minimized');
        }

        // Initial Load
        fetchArticle('Warren');
    </script>
</body>
</html>
